# Пример автоматически удаляемоего регламентного задания

[![Статус порога качества](https://sonarqube.samokhval.com/api/project_badges/measure?project=autoRemove-Scheduled-jobs&metric=alert_status)](https://sonarqube.samokhval.com/dashboard?id=autoRemove-Scheduled-jobs)
[![Рейтинг безопасности](https://sonarqube.samokhval.com/api/project_badges/measure?project=autoRemove-Scheduled-jobs&metric=security_rating)](https://sonarqube.samokhval.com/dashboard?id=autoRemove-Scheduled-jobs)
[![Технический долг](https://sonarqube.samokhval.com/api/project_badges/measure?project=autoRemove-Scheduled-jobs&metric=sqale_index)](https://sonarqube.samokhval.com/dashboard?id=autoRemove-Scheduled-jobs) [![Уязвимости](https://sonarqube.samokhval.com/api/project_badges/measure?project=autoRemove-Scheduled-jobs&metric=vulnerabilities)](https://sonarqube.samokhval.com/dashboard?id=autoRemove-Scheduled-jobs)

## Назначение

 Позволяет "поставить отложенное задание" и гарантированно его выполнить.
 Задание будет выполняться в течении дня пока не выполнится, а когда выполнится, автоматически удалится

## Окружение

**Платформа:** 8.3.18

**Режим совместимости:** 8.3.10

## Шаги воспроизведения

* Открыть обработку Генерация отложенных заданий
* Заполнить даты начала/окончания
* Выбрать элемент справочника
* Нажать кнопку Отложить
* Открыть обработку Консоль заданий 2019
* В списке активных регламентных заданий должно быть новое Регламентное задание с ключом "Отложенная запись <Название Номенклатуры>"
* Запустить регламентное задание
* Если задание завершено с ошибкой - изменить значение константы "ЗапрещатьПерезапись" в Ложь
* После успешного выполнения задание должно удалить себя 

![image](https://user-images.githubusercontent.com/24194977/121185190-7b912680-c86e-11eb-9a0f-91a30195181f.png)


``` bsl 

Процедура ОтложенноеЗадание( _Параметры = Неопределено ) Экспорт
	
	Если _Параметры = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	
	Попытка
		
		НоменклатураОбъект = _Параметры["Ссылка"].ПолучитьОбъект();
		НоменклатураОбъект.Используется = Истина;
		НоменклатураОбъект.Записать();
		
	Исключение
		
		_ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
		ЗаписьЖурналаРегистрации(
			Событие(),
			УровеньЖурналаРегистрации.Ошибка,
			_Параметры["Ссылка"].Метаданные(),
			_Параметры["Ссылка"], _ТекстОшибки);
			
		ВызватьИсключение _ТекстОшибки;	
		
	КонецПопытки;  
	
	УдалитьРегламентноеЗадание( _Параметры["Ссылка"] );
	
КонецПроцедуры


Функция НовыйОтборРегламентногоЗадания(КлючПоиска)
	
	Отбор = Новый Структура;
	Отбор.Вставить("Ключ", КлючПоиска);
	Отбор.Вставить("Метаданные", Метаданные.РегламентныеЗадания.ОтложенноеЗадание);
	Отбор.Вставить("Предопределенное", Ложь);
	Отбор.Вставить("Использование", Истина);
	Отбор.Вставить("Наименование", "Отложенное выполнение");

	Возврат Отбор;
	
КонецФункции


Процедура УдалитьРегламентноеЗадание(Знач Ссылка)
	
	Отбор = НовыйОтборРегламентногоЗадания(КлючЗадания(Ссылка));
	НайденныеРегламентныеЗадания  = РегламентныеЗадания.ПолучитьРегламентныеЗадания(Отбор);	
	
	Если НайденныеРегламентныеЗадания.Количество() Тогда
		
		Для каждого ЭлементКоллекции Из НайденныеРегламентныеЗадания Цикл
			
			ЭлементКоллекции.Удалить();
			
		КонецЦикла; 
		
	КонецЕсли;	
	
КонецПроцедуры

```
